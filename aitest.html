<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puter.js AI Chat</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Puter.js library -->
    <script src="https://js.puter.com/v2/"></script>
    <style>
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animation for the loading dots */
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        .dot-bounce > div {
            width: 10px;
            height: 10px;
            background-color: #9ca3af;
            border-radius: 100%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot-bounce .dot1 {
            animation-delay: -0.32s;
        }
        .dot-bounce .dot2 {
            animation-delay: -0.16s;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center h-screen">

    <!-- Main container for the app -->
    <div id="app-container" class="w-full max-w-2xl h-full md:h-[90vh]">
        <!-- Sign-in View -->
        <div id="sign-in-container" class="flex flex-col items-center justify-center h-full bg-white shadow-2xl rounded-lg">
            <h1 class="text-2xl font-bold mb-4">Welcome to AI Chat</h1>
            <p class="text-gray-600 mb-8">Please sign in with Puter to continue.</p>
            <button id="sign-in-button" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                Sign In with Puter
            </button>
        </div>

        <!-- Chat View (hidden by default) -->
        <div id="chat-container" class="flex flex-col w-full h-full bg-white shadow-2xl rounded-lg overflow-hidden hidden">
            <!-- Header -->
            <header class="bg-gray-800 text-white p-4 flex justify-between items-center border-b border-gray-700">
                <h1 class="text-xl font-bold">AI Chatbot</h1>
                <div class="relative">
                    <select id="model-selector" class="bg-gray-700 text-white border-none rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                        <!-- Models will be populated by JavaScript -->
                    </select>
                </div>
            </header>

            <!-- Chat Window -->
            <main id="chat-window" class="flex-1 p-6 overflow-y-auto bg-gray-50 space-y-4">
                 <!-- Welcome Message -->
                <div class="flex items-start gap-3 justify-start">
                    <div class="bg-blue-500 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xs">AI</div>
                    <div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xs md:max-w-md">
                        <p>Hello! Select a model from the dropdown above and ask me anything.</p>
                    </div>
                </div>
            </main>

            <!-- Message Input Form -->
            <footer class="p-4 bg-white border-t border-gray-200">
                <form id="chat-form" class="flex items-center gap-4">
                    <input type="text" id="message-input" placeholder="Type your message here..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" autocomplete="off">
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-3 px-5 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 disabled:bg-gray-400">
                        Send
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const signInContainer = document.getElementById('sign-in-container');
            const signInButton = document.getElementById('sign-in-button');
            const chatContainer = document.getElementById('chat-container');
            
            const chatWindow = document.getElementById('chat-window');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const modelSelector = document.getElementById('model-selector');
            const sendButton = chatForm.querySelector('button');

            // Store the conversation history
            let conversationHistory = [];
            
            /**
             * Populates the dropdown with a pre-defined list of AI models.
             */
            const populateModels = () => {
                modelSelector.innerHTML = ''; // Clear any previous content

                // Model data from the JSON file provided by the user
                const modelData = {
                    "models": ["gpt-5-2025-08-07","gpt-5","gpt-5-mini-2025-08-07","gpt-5-mini","gpt-5-nano-2025-08-07","gpt-5-nano","gpt-5-chat-latest","gpt-4o","gpt-4o-mini","o1","o1-mini","o1-pro","o3","o3-mini","o4-mini","gpt-4.1","gpt-4.1-mini","gpt-4.1-nano","gpt-4.5-preview","claude-sonnet-4-5-20250929","claude-sonnet-4.5","claude-sonnet-4-5","claude-opus-4-1-20250805","claude-opus-4-1","claude-opus-4-20250514","claude-opus-4","claude-opus-4-latest","claude-sonnet-4-20250514","claude-sonnet-4","claude-sonnet-4-latest","claude-3-7-sonnet-20250219","claude-3-7-sonnet-latest","claude-3-5-sonnet-20241022","claude-3-5-sonnet-latest","claude-3-5-sonnet-20240620","claude-3-haiku-20240307","gemini-1.5-flash","gemini-2.0-flash","grok-beta","grok-vision-beta","grok-3","grok-3-fast","grok-3-mini","grok-3-mini-fast","grok-2-vision","grok-2","deepseek-chat","deepseek-reasoner","mistral-large-latest", "mistral-small-latest", "open-mistral-nemo"]
                };

                const models = modelData.models.map(id => {
                    let provider = 'Other';
                    if (id.startsWith('gpt')) provider = 'OpenAI';
                    else if (id.startsWith('claude')) provider = 'Anthropic';
                    else if (id.startsWith('gemini')) provider = 'Google';
                    else if (id.startsWith('grok')) provider = 'xAI';
                    else if (id.startsWith('deepseek')) provider = 'DeepSeek';
                    else if (id.startsWith('mistral') || id.startsWith('open-mistral')) provider = 'Mistral';

                    // Create a more readable name
                    const name = id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    return { id, name, provider };
                });

                // Group models by provider
                const groupedModels = models.reduce((acc, model) => {
                    if (!acc[model.provider]) {
                        acc[model.provider] = [];
                    }
                    acc[model.provider].push(model);
                    return acc;
                }, {});

                // Populate the dropdown with optgroups
                for (const provider in groupedModels) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = provider;
                    
                    groupedModels[provider].forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        optgroup.appendChild(option);
                    });

                    modelSelector.appendChild(optgroup);
                }

                modelSelector.disabled = false;
            };

            // Initialize the app
            const initializeApp = async () => {
                const isSignedIn = await puter.auth.isSignedIn();
                if (isSignedIn) {
                    signInContainer.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    populateModels(); // Populate models from the embedded list
                } else {
                    signInContainer.classList.remove('hidden');
                    chatContainer.classList.add('hidden');
                }
            };

            // Event listener for the sign-in button
            signInButton.addEventListener('click', async () => {
                try {
                    await puter.auth.signIn();
                    initializeApp(); // Re-initialize to show chat after successful sign-in
                } catch (error) {
                    console.error('Sign-in failed:', error);
                    alert('Could not sign in. Please try again.');
                }
            });

            // Handle form submission
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = messageInput.value.trim();
                if (!userInput) return;

                const selectedModel = modelSelector.value;
                
                // Add user message to UI and history
                addMessageToUI(userInput, 'user');
                conversationHistory.push({ role: 'user', content: userInput });

                messageInput.value = '';
                sendButton.disabled = true;

                // Show loading indicator
                showLoadingIndicator();

                try {
                    // Call Puter.js AI
                    const response = await puter.ai.chat(conversationHistory, {
                        model: selectedModel,
                    });
                    
                    // Safely access the response content
                    const aiResponse = response?.choices?.[0]?.message?.content;

                    if (aiResponse) {
                        // Add AI response to UI and history
                        addMessageToUI(aiResponse, 'assistant');
                        conversationHistory.push({ role: 'assistant', content: aiResponse });
                    } else {
                        // Handle cases where response format is unexpected
                        throw new Error("Received an unexpected or empty response from the AI.");
                    }

                } catch (error) {
                    console.error('Error calling Puter.js AI:', error);
                    let errorMessage = `Sorry, there was an error. The model might not be available.`;
                    
                    // Try to parse a more specific error message from Puter.js
                    if (typeof error === 'object' && error !== null && error.error && error.error.message) {
                        errorMessage += ` (Error: ${error.error.message})`;
                    } else if (error.message) {
                        errorMessage += ` (Error: ${error.message})`;
                    }
                    
                    addMessageToUI(errorMessage, 'error');
                } finally {
                    // Clean up
                    removeLoadingIndicator();
                    sendButton.disabled = false;
                    messageInput.focus();
                }
            });

            /**
             * Adds a message to the chat UI.
             * @param {string} message - The message content.
             * @param {'user' | 'assistant' | 'error'} role - The sender of the message.
             */
            function addMessageToUI(message, role) {
                const messageContainer = document.createElement('div');
                messageContainer.className = 'flex items-start gap-3';

                let messageBubble;
                let avatar;

                switch (role) {
                    case 'user':
                        messageContainer.classList.add('justify-end');
                        avatar = createAvatar('You', 'bg-green-500');
                        messageBubble = createMessageBubble(message, 'bg-blue-600', 'text-white');
                        messageContainer.append(messageBubble, avatar);
                        break;
                    case 'assistant':
                        messageContainer.classList.add('justify-start');
                        avatar = createAvatar('AI', 'bg-blue-500');
                        messageBubble = createMessageBubble(message, 'bg-gray-200', 'text-gray-800');
                        messageContainer.append(avatar, messageBubble);
                        break;
                    case 'error':
                         messageContainer.classList.add('justify-start');
                        avatar = createAvatar('!', 'bg-red-500');
                        messageBubble = createMessageBubble(message, 'bg-red-100', 'text-red-800');
                        messageContainer.append(avatar, messageBubble);
                        break;
                }
                
                chatWindow.appendChild(messageContainer);
                chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to the bottom
            }

            /**
             * Creates an avatar element.
             * @param {string} text - The text inside the avatar.
             * @param {string} bgColor - The background color class.
             * @returns {HTMLDivElement}
             */
            function createAvatar(text, bgColor) {
                const avatar = document.createElement('div');
                avatar.className = `${bgColor} text-white p-2 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xs flex-shrink-0`;
                avatar.textContent = text;
                return avatar;
            }

            /**
             * Creates a message bubble element.
             * @param {string} text - The message text.
             * @param {string} bgColor - The background color class.
             * @param {string} textColor - The text color class.
             * @returns {HTMLDivElement}
             */
            function createMessageBubble(text, bgColor, textColor) {
                const bubble = document.createElement('div');
                bubble.className = `${bgColor} ${textColor} p-3 rounded-lg max-w-xs md:max-w-md`;
                // Basic markdown for bold and italics
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
                bubble.innerHTML = text;
                return bubble;
            }

            /**
             * Shows a loading indicator in the chat window.
             */
            function showLoadingIndicator() {
                const loadingContainer = document.createElement('div');
                loadingContainer.id = 'loading-indicator';
                loadingContainer.className = 'flex items-start gap-3 justify-start';

                const avatar = createAvatar('AI', 'bg-blue-500');
                
                const bubble = document.createElement('div');
                bubble.className = 'bg-gray-200 text-gray-800 p-3 rounded-lg';
                
                const dots = document.createElement('div');
                dots.className = 'dot-bounce';
                dots.innerHTML = '<div class="dot1"></div><div class="dot2"></div><div class="dot3"></div>';
                
                bubble.appendChild(dots);
                loadingContainer.append(avatar, bubble);
                chatWindow.appendChild(loadingContainer);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

             /**
             * Removes the loading indicator from the chat window.
             */
            function removeLoadingIndicator() {
                const indicator = document.getElementById('loading-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            // Start the app
            initializeApp();
        });
    </script>
</body>
</html>

